<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <title>Urban flame stage 1</title>
   </head>
   <body>
      <canvas id="canvas" width="1700" height="925"></canvas>
      <style> canvas {
         background: rgb(7, 137, 18)
         }
      </style>
      <script>
         var lifeCount = 3;
         var isInvincible = false;
         var invincibleTimer = 0;
         var isattacking = false;
         var attackTimer = 0;
          console.log(lifeCount)
         const canvas = document.getElementById("canvas");
         const ctx = canvas.getContext("2d");
         
         // 플레이어(사각형) 기본 설정
         const img = {
           x: 250,
           y: 100,
           size: 80,
           speed: 12,
         };
         
         const Normalguy = {
           otherx: 300,
           othery: 200,
           othersize: 80,
           otherspeed: 2,
           directionX: Math.random() > 0.5 ? 1 : -1,
           directionY: Math.random() > 0.5 ? 1 : -1,
         };
         
           const Normalboi = {
           otherX: 120,
           otherY: 450,
           otherSIZE: 80,
           otherSPEED: 2,
           directionx: Math.random() > 0.5 ? 1 : -1,
           directiony: Math.random() > 0.5 ? 1 : -1,
         };
         
          const Youtuber = {
           ThirdX: 300,
           ThirdY: 150,
           ThirdSize: 90,
           ThirdSpeed: 2,
           diX: Math.random() > 0.5 ? 1.5 : -1,
           diY: Math.random() > 0.5 ? 1.5 : -1,
         };
         
         // 이미지 객체 생성 및 로드 (한 번만 생성)
         const DontMakeThisACultImage = new Image();
         DontMakeThisACultImage.src = "character/9.png";
         
         const erdragonImage = new Image();
         erdragonImage.src = "character/10.png";
         
         const imgImage = new Image();
         imgImage.src = "character/1.png";
         
         const NormalguyImage = new Image();
         NormalguyImage.src = "character/5.png";
         
                  const NormalboiImage = new Image();
         NormalboiImage.src = "character/5.png";
         
         const YoutuberImage = new Image();
         YoutuberImage.src = "character/7.png";
         
         // 벽 배열 정의 (x, y, width, height)
         const walls = [
           {x: 500, y: 300, width: 200, height: 170},
           {x: 1000, y: 300, width: 200, height: 170},
           {x: 1250, y: 300, width: 200, height: 170},
           {x: 750, y: 300, width: 200, height: 170},
           {x: 500, y: 490, width: 200, height: 170},
           {x: 1000, y: 490, width: 200, height: 170},
           {x: 1250, y: 490, width: 200, height: 170},
           {x: 750, y: 490, width: 200, height: 170},
           {x: 500, y: 680, width: 200, height: 170},
           {x: 1000, y: 680, width: 200, height: 170},
           {x: 1250, y: 680, width: 200, height: 170},
           {x: 750, y: 680, width: 200, height: 170},
         ];
         
         // 충돌 감지 함수 (충돌 여부만 반환)
         function checkWallCollision(x, y, size) {
           for (let wall of walls) {
             // 충돌 체크
             if (x < wall.x + wall.width &&
                 x + size > wall.x &&
                 y < wall.y + wall.height &&
                 y + size > wall.y) {
               return true;
             }
           }
           return false;
         }

         // 적 충돌 감지 함수 (플레이어와 NPC들의 충돌 체크) - NPC 객체를 직접 참조
         function checkEnemyCollision(px, py, psize) {
           // Normalguy와 충돌 체크
           if (px < Normalguy.otherx + Normalguy.othersize && 
               px + psize > Normalguy.otherx &&
               py < Normalguy.othery + 125 &&
               py + psize > Normalguy.othery &&
              isattacking == false) {
             return true; 
           }if (px < Normalguy.otherx + Normalguy.othersize && 
               px + psize > Normalguy.otherx &&
               py < Normalguy.othery + 125 &&
               py + psize > Normalguy.othery &&
               isattacking == true){
              Normalguy.directionX *= -1;
             Normalguy.directionY *= -1;
              return false }
           
           // Normalboi와 충돌 체크
           if (px < Normalboi.otherX + Normalboi.otherSIZE && 
               px + psize > Normalboi.otherX &&
               py < Normalboi.otherY + 130 &&
               py + psize > Normalboi.otherY &&
              isattacking == false) {
             return true
              }if (px < Normalboi.otherX + Normalboi.otherSIZE && 
               px + psize > Normalboi.otherX &&
               py < Normalboi.otherY + 130 &&
               py + psize > Normalboi.otherY &&
               isattacking == true) {
            Normalboi.directionx *= -1;
             Normalboi.directiony *= -1;
            return false}
           
           // Youtuber와 충돌 체크
           if (px < Youtuber.ThirdX + Youtuber.ThirdSize && 
               px + psize > Youtuber.ThirdX &&
               py < Youtuber.ThirdY + 130 &&
               py + psize > Youtuber.ThirdY &&
              isattacking == false) {
             return true;
           }if (px < Youtuber.ThirdX + Youtuber.ThirdSize && 
               px + psize > Youtuber.ThirdX &&
               py < Youtuber.ThirdY + 130 &&
               py + psize > Youtuber.ThirdY &&
               isattacking == true){
        Youtuber.diX *= -1;
        Youtuber.diY*= -1; 
        return false;
      }}
    
         
         // 현재 눌려 있는 키 상태
         const keys = {
           w: false,
           a: false,
           s: false,
           d: false,
           q: false,
         };
         
         // 키 입력 이벤트 등록 (한 번만 등록)
         window.addEventListener("keydown", (e) => {
           const key = e.key.toLowerCase();
           if (key in keys) {
             keys[key] = true;
           }
         });
         
         window.addEventListener("keyup", (e) => {
           const key = e.key.toLowerCase();
           if (key in keys) {
             keys[key] = false;
           }
         });
         
         // 위치 업데이트 함수
         function update() {
           // 플레이어 이동 처리
           let prevX = img.x;
           let prevY = img.y;
           
           // WASD 에 따라 위치 변경
           if (keys.w) img.y -= img.speed; // 위
           if (keys.s) img.y += img.speed; // 아래
           if (keys.a) img.x -= img.speed; // 왼쪽
           if (keys.d) img.x += img.speed; // 오른쪽
           if (keys.q && isattacking == false) isattacking = true;// 공격
           
         
           // 벽 충돌 체크 먼저
           if (checkWallCollision(img.x, img.y, img.size)) {
             img.x = prevX;
             img.y = prevY;
           }
           
           // 무적 상태 타이머 업데이트
           if (isInvincible) {
             invincibleTimer--;
             if (invincibleTimer <= 0) {
               isInvincible = false;
             }
           }
          // 타이머 발동
           if (isattacking){
              attackTimer--;
              attackTimer= 30; // 약 0.5초간 무적 (30프레임)
             console.log("You pushed the enemy, they took a step back.");
           } if (attackTimer <= 0) {
               isattacking = false;}
           
           
           // 적과 충돌 체크 (damage 감지) - 무적 상태가 아닐 때만
           if (!isInvincible && checkEnemyCollision(img.x, img.y, img.size)) {
             lifeCount = lifeCount - 1;
             isInvincible = true;
             invincibleTimer = 60; // 약 1초간 무적 (60프레임)
             console.log("Life lost! Remaining: " + lifeCount);
           }

           // 캔버스 밖으로 못 나가게 제한
           if (img.x < 0) img.x = 0;
           if (img.y < 0) img.y = 0;
           if (img.x + img.size > canvas.width) {
             img.x = canvas.width - img.size;
           }
           if (img.y + img.size > canvas.height) {
             img.y = canvas.height - img.size;
           }
           
           // Normalguy 위치 업데이트 - 방향에 따라 위치 변경
           let prevNormalguyX = Normalguy.otherx;
           let prevNormalguyY = Normalguy.othery;
           
           Normalguy.otherx += Normalguy.otherspeed * Normalguy.directionX;
           Normalguy.othery += Normalguy.otherspeed * Normalguy.directionY;
         
           // Normalguy 벽 충돌 체크
           if (checkWallCollision(Normalguy.otherx, Normalguy.othery, Normalguy.othersize)) {
             Normalguy.otherx = prevNormalguyX;
             Normalguy.othery = prevNormalguyY;
             Normalguy.directionX *= -1;
             Normalguy.directionY *= -1;
           }
           
           // Normalguy 경계 체크 - 캔버스 밖으로 못 나가게 제한
           if (Normalguy.otherx < 0) {
             Normalguy.otherx = 0;
             Normalguy.directionX = 1;
           }
           if (Normalguy.othery < 0) {
             Normalguy.othery = 0;
             Normalguy.directionY = 1;
           }
           if (Normalguy.otherx + Normalguy.othersize > canvas.width) {
             Normalguy.otherx = canvas.width - Normalguy.othersize;
             Normalguy.directionX = -1;
           }
           if (Normalguy.othery + Normalguy.othersize > canvas.height) {
             Normalguy.othery = canvas.height - Normalguy.othersize;
             Normalguy.directionY = -1;
           }
         
           // Normalboi 위치 업데이트 - 방향에 따라 위치 변경
           let prevNormalboiX = Normalboi.otherX;
           let prevNormalboiY = Normalboi.otherY;
           
           Normalboi.otherX += Normalboi.otherSPEED * Normalboi.directionx;
           Normalboi.otherY += Normalboi.otherSPEED * Normalboi.directiony;
         
           // Normalboi 벽 충돌 체크
           if (checkWallCollision(Normalboi.otherX, Normalboi.otherY, Normalboi.otherSIZE)) {
             Normalboi.otherX = prevNormalboiX;
             Normalboi.otherY = prevNormalboiY;
             Normalboi.directionx *= -1;
             Normalboi.directiony *= -1;
           }
           
           // Normalboi 경계 체크 - 캔버스 밖으로 못 나가게 제한
           if (Normalboi.otherX < 0) {
             Normalboi.otherX = 0;
             Normalboi.directionx = 1;
           }
           if (Normalboi.otherY < 0) {
             Normalboi.otherY = 0;
             Normalboi.directiony = 1;
           }
           if (Normalboi.otherX + Normalboi.otherSIZE > canvas.width) {
             Normalboi.otherX = canvas.width - Normalboi.otherSIZE;
             Normalboi.directionx = -1;
           }
           if (Normalboi.otherY + Normalboi.otherSIZE > canvas.height) {
             Normalboi.otherY = canvas.height - Normalboi.otherSIZE;
             Normalboi.directiony = -1;
           }
         
           // Youtuber 위치 업데이트 - 방향에 따라 위치 변경
           let prevYoutuberX = Youtuber.ThirdX;
           let prevYoutuberY = Youtuber.ThirdY;
           
           Youtuber.ThirdX += Youtuber.ThirdSpeed * Youtuber.diX;
           Youtuber.ThirdY += Youtuber.ThirdSpeed * Youtuber.diY;
         
           // Youtuber 벽 충돌 체크
           if (checkWallCollision(Youtuber.ThirdX, Youtuber.ThirdY, Youtuber.ThirdSize)) {
             Youtuber.ThirdX = prevYoutuberX;
             Youtuber.ThirdY = prevYoutuberY;
             Youtuber.diX *= -1;
             Youtuber.diY *= -1;
           }
           
           // Youtuber 경계 체크 - 캔버스 밖으로 못 나가게 제한
           if (Youtuber.ThirdX < 0) {
             Youtuber.ThirdX = 0;
             Youtuber.diX = 1;
           }
           if (Youtuber.ThirdY < 0) {
             Youtuber.ThirdY = 0;
             Youtuber.diY = 1;
           }
           if (Youtuber.ThirdX + Youtuber.ThirdSize > canvas.width) {
             Youtuber.ThirdX = canvas.width - Youtuber.ThirdSize;
             Youtuber.diX = -1;
           }
           if (Youtuber.ThirdY + Youtuber.ThirdSize > canvas.height) {
             Youtuber.ThirdY = canvas.height - Youtuber.ThirdSize;
             Youtuber.diY = -1;
           }}

         // 화면 그리기 함수
         function draw(){ 
           // 캔버스 지우기
           ctx.clearRect(0, 0, 2000, 1000);
         
           // 배경 그리기 - 벽들 그리기
           ctx.fillStyle = "maroon";
           ctx.fillRect(walls[0].x, walls[0].y, walls[0].width, walls[0].height);
           
           for (let i = 1; i < walls.length; i++) {
             ctx.fillRect(walls[i].x, walls[i].y, walls[i].width, walls[i].height);
           }
           
            // End 그리기 (이미 로드된 이미지 사용)
           if (erdragonImage.complete) {
             ctx.drawImage(erdragonImage, 1500, 325, 125, 125)
           }
            // Spawnpoint 그리기 (이미 로드된 이미지 사용)
           if (DontMakeThisACultImage.complete) {
             ctx.drawImage(DontMakeThisACultImage, 62.5, 100, 125, 125)
           }
               // 플레이어 그리기 (이미 로드된 이미지 사용)
           if (imgImage.complete) {
             ctx.drawImage(imgImage, img.x, img.y, img.size, img.size);
           }
           // Normalguy 그리기 (이미 로드된 이미지 사용)
           if (NormalguyImage.complete) {
             ctx.drawImage(NormalguyImage, Normalguy.otherx, Normalguy.othery, Normalguy.othersize, 125);
           }
           // Normalboi 그리기 (이미 로드된 이미지 사용)
           if (NormalboiImage.complete){
             ctx.drawImage(NormalboiImage, Normalboi.otherX, Normalboi.otherY, Normalboi.otherSIZE, 130);
           }
           // Youtuber 그리기 (이미 로드된 이미지 사용)
           if (YoutuberImage.complete) {
             ctx.drawImage(YoutuberImage, Youtuber.ThirdX, Youtuber.ThirdY, Youtuber.ThirdSize, 150)
           }}
         
         // 게임 루프
         function loop(){
        update();
          draw();
          requestAnimationFrame(loop);}
          loop();
          </script>
   </body>
</html>